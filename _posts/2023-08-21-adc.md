---
layout: post
title: Analog-digital conversion
tags: zephyr
categories: 
usemathjax: true
---

To interact with the world, the inverter will need to be able to measure voltages and currents at its inputs and outputs, as well as internal state. This is the realm of [analog-digital conversion](https://en.wikipedia.org/wiki/Analog-to-digital_converter). Because this need is so ubiquitous, many microcontrollers have some capability built-in. The nRF52840 has a [successive approximation ADC](https://en.wikipedia.org/wiki/Successive-approximation_ADC) peripheral, [documentation here](https://infocenter.nordicsemi.com/index.jsp?topic=%2Fps_nrf52840%2Fsaadc.html). Its specs are reasonable: 8 single ended channels, 200 ksps overall sample rate, 12 bit resolution (14 with oversampling), 9 bits effective after noise and distortion. Much fancier units exist, but this is already there, on the chip. Maybe it'll be good enough.

Before going over how to use the ADC, let's talk about what our requirements on accuracy are. For a microinverter, the authors of IEEE 1547 were kind of enough to figure out minimal requirements. These are at least an excellent starting point. Here are some of the requirements taken from Table 3 in IEEE 1547-2018 Section 4.4:

| Parameter      | Minimum measurement accuracy | Measurement window | Range        |
| -------------- | ---------------------------- | ------------------ | ------------ |
| Voltage RMS    | ±1% V<sub>nom</sub>                  | 10 cycles          | 0.5 - 1.2 pu |
| Frequency      | 10 mHz                       | 60 cycles          | 50 - 66 Hz   |
| Active power   | ±5% rated power              | 10 cycles          | 0.2 - 1.0 pu |
| Reactive power | ±5% rated power              | 10 cycles          | 0.2 - 1.0 pu |
| Time           | 1% of measured duraction     | N/A                | 5 - 600 s    | 

There are more specs for transient measurements. These look largely easy to achieve, with the possible exception of the 1% voltage measurement. Getting the noise down to that level isn't bad, 1% is 7 bits, but the accuracy of the voltage reference now matters if we want our total error to be sub 1%. The nRF52840 allows use of an internal 0.6V reference, or using the chip's VDD (usually 3.3V) as a reference. This chip does not support an external reference. The 0.6V reference has no electrical specification for its accuracy, but a Nordic engineer [claimed](https://devzone.nordicsemi.com/f/nordic-q-a/80183/reference-accuracy) it's good to 0.2% at room temperature, and 2-3% over its full voltage and temperature range. The chip power is whatever you give it. It's not normally great to use as a reference, since the line is likely noisy and the output levels are not intended as a reference. But we can also use the 3.3V for measuring signals and measure the 3.3V with the 0.6V. 